{% extends "dashboard/dashboard_base.html" %}
{% load static %}
{% block content %}

  <!-- <div class="row">
    <div class="col-md-12 grid-margin">
      <div class="row">
        <div class="col-12 col-xl-8 mb-4 mb-xl-0">
          <h3 class="font-weight-bold">Deposit Instructions</h3>
        </div>
        <div class="col-12 col-xl-4">
         <div class="justify-content-end d-flex">
          <div class="dropdown flex-md-grow-1 flex-xl-grow-0">
            <button class="btn btn-sm btn-light bg-white dropdown-toggle" type="button" id="dropdownMenuDate2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
             <i class="mdi mdi-calendar"></i> Today (10 Jan 2021)
            </button>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuDate2">
              <a class="dropdown-item" href="#">January - March</a>
              <a class="dropdown-item" href="#">March - June</a>
              <a class="dropdown-item" href="#">June - August</a>
              <a class="dropdown-item" href="#">August - November</a>
            </div>
          </div>
         </div>
        </div>
      </div>
    </div>
  </div> -->
  
  <div class="row">
    <div class="col-md-6 stretch-card transparent">
           <div class="card card-tale" style="cursor: context-menu;">
            <div class="card-body">
              <div>
              <p class="">
                <img src="{% static 'img/images/deposit.jpg' %}" class="img-fluid" alt="">
              </p>
              <p class="pt-3" style="font-size: 16px; font-weight: 600;">
                STK PUSH MPESA DEPOSIT
              </p>



                  <form id="depositForm" action="{% url 'deposits:daraja_stk_push' %}" method="POST">
                      {{ deposit_form.as_div }}
                      {% csrf_token %}
                      <p>
                        <input type="submit" id="depositBtn" class="btn btn-primary mt-3" value="Place Deposit">
                      </p>
                 </form>

              </div>
              <div>
              </div>
            </div>
          </div>
        </div>
      <div class="col-md-6 stretch-card transparent">
           <div class="card card-tale" style="cursor: context-menu;">
            <div class="card-body">
              <div>
              <p class="">
                <img src="{% static 'img/images/deposit.jpg' %}" class="img-fluid" alt="">
              </p>
              <p class="pt-3" style="font-size: 16px; font-weight: 600;">
                Lipa na Mpesa DEPOSIT
              </p>
               <p class="pt-3" style="font-size: 16px; font-weight: 600;">
                Payment cannot be reversed
              </p>
              <ol start="" style="font-weight: 600;">
                <li>Payment cannot be reversed</li>
                <li>Select Pay Bill</li>
                <li>Business Number "880100"</li>
                <li>Account Number "436137"</li>
                <li>Enter the amount you wish to pay</li>
                <li>Enter your M-PESA PIN</li>
                <li>send screenshot to ceo</li>
              </ol>
                <p class="" style="font-size: 12px; font-weight: 600;">
                REFRESH THE DASHBOARD AND WITHIN 5 MINUTES THE AMOUNT WILL REFLECT.
              </p>
         
              </div>
              <div>
              </div>
            </div>
          </div>
        </div>
       
    </div>
    <div class="row mt-5">
    <div class="col-md-4 stretch-card transparent">
           <div class="card card-tale" style="cursor: context-menu;">
            <div class="card-body">
              <div>
              <p class="">
                <img src="{% static 'img/images/vodacom.jpg' %}" class="img-fluid" alt="">
              </p>
              <p class="pt-3" style="font-size: 16px; font-weight: 600;">
                Vodacom Tanzania Deposit
              </p>
               <ol start="" style="font-weight: 600;">
                <li>Dial *150*00#"</li>
                <li>Select Send Money</li>
                <li>Select International Transfer</li>
                <li>Select Safaricom Mpesa</li>
                <li>Enter Pin</li>
              </ol>
              <p class="" style="font-size: 12px; font-weight: 600;">
               REFRESH THE DASHBOARD AND WITHIN 5 MINUTES THE AMOUNT WILL REFLECT.
             </p>
             </div>
              <div>
              </div>
            </div>
          </div>
        </div>
      <div class="col-md-4 stretch-card transparent">
           <div class="card card-tale" style="cursor: context-menu;">
            <div class="card-body">
              <div>
              <p class="">
                <img src="{% static 'img/mtn-rwanda.jpg' %}" class="img-fluid" alt="">
              </p>
              <p class="pt-3" style="font-size: 16px; font-weight: 600;">
                MTN RWANDA Deposit
              </p>
               <ol start="" style="font-weight: 600;">
                <li>Dial *830#</li>
                <li>Select Send Money</li>
                <li>Select International Transfer</li>
                <li>Select Safaricom Mpesa</li>
            
                <li>Enter Pin</li>
              </ol>
                <p class="" style="font-size: 12px; font-weight: 600;">
                REFRESH THE DASHBOARD AND WITHIN 5 MINUTES THE AMOUNT WILL REFLECT.
              </p>
         
              </div>
              <div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 stretch-card transparent">
           <div class="card card-tale" style="cursor: context-menu;">
            <div class="card-body">
              <div>
              <p class="">
                <img src="{% static 'img/mtn.jpg' %}" class="img-fluid" alt="">
              </p>
              <p class="pt-3" style="font-size: 16px; font-weight: 600;">
                MTN UGANDA Deposit
              </p>
              <ol start="" style="font-weight: 600;">
                <li>Dial *165#</li>
                <li>Select Send Money</li>
                <li>Select International Transfer</li>
                <li>Select Safaricom Mpesa</li>
              
                <li>Enter Pin</li>
              </ol>
                <p class="" style="font-size: 12px; font-weight: 600;">
                REFRESH THE DASHBOARD AND WITHIN 5 MINUTES THE AMOUNT WILL REFLECT.
              </p>
         
              </div>
              <div>
              </div>
            </div>
          </div>
        </div>
       
    </div>

  <div class="card mt-5">
    <h4>Deposits Table</h4>

    <table class="mt-3">
    <thead>
    <tr>
      <th>SN</th>
      <th>Amount</th>
      <th>Reference Code</th>
      <th>Date</th>
      <th>Payment Confirmed</th>
    </tr>
    </thead>

    <tbody>
      {% for user_deposit in user_deposits %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>{{ user_deposit.amount }}</td>
      <td>{{ user_deposit.reference_code }}</td>
      <td>{{ user_deposit.created }}</td>
   
      <td>
        {% if user_deposit.paid %}
            <button class="btn text-white" style="background: #28a745;">Approved</button>
        {% else %}
            <button class="btn text-white" style="background: #F3797E;">Pending</button>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
    </tbody>

    </table>

    <div class="pagination mt-3">
    <button>Previous</button>
    <button>1</button>
    <button>Next</button>
    </div>
</div>




  


{% comment %}

<script>
  document.getElementById("depositForm").addEventListener("submit", async function(e){
    e.preventDefault();
    const form = e.target;
    const formData = new FormData(form);
    const res = await fetch(form.action, {
      method: "POST",
      headers: {"X-CSRFToken": formData.get("csrfmiddlewaretoken")},
      body: formData
    });
    const data = await res.json();
    const box = document.getElementById("messagesContainer");
    if (!data.ok){
      box.innerText = data.error || "Something went wrong";
      return;
    }
    box.innerText = data.message || "STK push sent. Enter M-PESA PIN on your phone…";
    const checkoutId = data.checkout_request_id;
    const poll = setInterval(async ()=>{
      const sres = await fetch(`/mpesa/status/${checkoutId}/`);
      const sdata = await sres.json();
      if (sdata.status !== "PENDING"){
        clearInterval(poll);
        box.innerText = sdata.status === "SUCCESS" ? "Payment received!" : `Failed: ${sdata.result_desc}`;
        location.reload();
      }
    }, 3000);
  });
</script>

<!-- Script for automatic deposit transactions using the B2C Express -->
<script>
  document.getElementById("depositForm").addEventListener("submit", async function (e) {
    e.preventDefault(); // Prevent form's default submission

    const form = e.target;
    const formData = new FormData(form);
    const csrfToken = formData.get("csrfmiddlewaretoken");
    const box = document.getElementById("messagesContainer");

    try {
      const res = await fetch(form.action, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken
        },
        body: formData
      });

      const data = await res.json();

      if (!data.ok) {
        box.innerText = data.error || "Something went wrong";
        return;
      }

      box.innerText = data.message || "STK push sent. Enter M-PESA PIN on your phone…";
      const checkoutId = data.checkout_request_id;

      // Start polling for payment status
      const poll = setInterval(async () => {
        try {
          const sres = await fetch(`/mpesa/status/${checkoutId}/`);
          const sdata = await sres.json();

          if (sdata.status !== "PENDING") {
            clearInterval(poll);
            box.innerText = sdata.status === "SUCCESS"
              ? "✅ Payment received!"
              : `❌ Failed: ${sdata.result_desc || "Transaction failed"}`;
            location.reload(); // Optional
          }
        } catch (pollError) {
          clearInterval(poll);
          box.innerText = "Error checking payment status.";
          console.error("Polling error:", pollError);
        }
      }, 3000);

    } catch (error) {
      box.innerText = "An error occurred while processing your request.";
      console.error("Submission error:", error);
    }
  });
</script>


<!-- Script to iniitiate manual transactions -->
<script>

    document.getElementById("depositForm").addEventListener("submit", function(event) {
        event.preventDefault(); // Prevent default form submission

        let form = this;
        let formData = new FormData(form);

        fetch(form.action, {
            method: "POST",
            body: formData
        })
        .then(response => response.text())  // Expecting HTML response with messages
        .then(html => {
            // Parse response HTML
            let parser = new DOMParser();
            let doc = parser.parseFromString(html, "text/html");

            // Extract messages and update the page
            let messagesContainer = document.getElementById("messagesContainer");
            let newMessages = doc.getElementById("messagesContainer");

            if (newMessages) {
                messagesContainer.innerHTML = newMessages.innerHTML;
            }

            // If deposit was successful, trigger USSD deposit
            if (newMessages && newMessages.innerText.includes("successfully")) {
              openUSSD();
              form.reset();  // Clear input fields  
              

            }
        })
        .catch(error => console.error("Error:", error));
     });


  function openUSSD() {
      // Replace this with your USSD logic
   

      let phone = document.getElementById("id_phone_number").value;
      let amount = document.getElementById("id_amount").value;

      if (phone && amount) {
          let ussdCode = `tel:*334*1*${phone}*${amount}#`;
          window.location.href = ussdCode;  // Open USSD dialer
      } else {
          alert("Please enter phone number and amount.");
      }

      alert("USSD deposit initiated!");
  }

</script>


{% endcomment %}



{% endblock %}