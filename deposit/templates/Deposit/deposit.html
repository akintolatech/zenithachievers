{% extends "dashboard/dashboard_base.html" %}
{% load static %}
{% block content %}

  <!-- <div class="row">
    <div class="col-md-12 grid-margin">
      <div class="row">
        <div class="col-12 col-xl-8 mb-4 mb-xl-0">
          <h3 class="font-weight-bold">Deposit Instructions</h3>
        </div>
        <div class="col-12 col-xl-4">
         <div class="justify-content-end d-flex">
          <div class="dropdown flex-md-grow-1 flex-xl-grow-0">
            <button class="btn btn-sm btn-light bg-white dropdown-toggle" type="button" id="dropdownMenuDate2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
             <i class="mdi mdi-calendar"></i> Today (10 Jan 2021)
            </button>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuDate2">
              <a class="dropdown-item" href="#">January - March</a>
              <a class="dropdown-item" href="#">March - June</a>
              <a class="dropdown-item" href="#">June - August</a>
              <a class="dropdown-item" href="#">August - November</a>
            </div>
          </div>
         </div>
        </div>
      </div>
    </div>
  </div> -->
  <div id="messageBox"></div>
  <div class="row">
    <div class="col-md-6 stretch-card transparent">
           <div class="card card-tale" style="cursor: context-menu;">
            <div class="card-body">
              <div>
              <p class="">
                <img src="{% static 'img/images/deposit.jpg' %}" class="img-fluid" alt="">
              </p>
              <p class="pt-3" style="font-size: 16px; font-weight: 600;">
                STK PUSH MPESA DEPOSIT
              </p>

                  <form id="depositForm" action="{% url 'deposits:ajax_deposit' %}" method="POST">
                      {{ deposit_form.as_div }}
                      {% csrf_token %}
                      <p>
                        <input type="submit" id="depositBtn" class="btn btn-primary mt-3" value="Place Deposit">
                      </p>
                 </form>

              </div>
              <div>
              </div>
            </div>
          </div>
        </div>
      <div class="col-md-6 stretch-card transparent">
           <div class="card card-tale" style="cursor: context-menu;">
            <div class="card-body">
              <div>
              <p class="">
                <img src="{% static 'img/images/deposit.jpg' %}" class="img-fluid" alt="">
              </p>
              <p class="pt-3" style="font-size: 16px; font-weight: 600;">
                Lipa na Mpesa DEPOSIT
              </p>
               <p class="pt-3" style="font-size: 16px; font-weight: 600;">
                Payment cannot be reversed
              </p>
              <ol start="" style="font-weight: 600;">
                <li>Payment cannot be reversed</li>
                <li>Select Pay Bill</li>
                <li>Business Number "880100"</li>
                <li>Account Number "436137"</li>
                <li>Enter the amount you wish to pay</li>
                <li>Enter your M-PESA PIN</li>
                <li>send screenshot to ceo</li>
              </ol>
                <p class="" style="font-size: 12px; font-weight: 600;">
                REFRESH THE DASHBOARD AND WITHIN 5 MINUTES THE AMOUNT WILL REFLECT.
              </p>
         
              </div>
              <div>
              </div>
            </div>
          </div>
        </div>
       
    </div>
    <div class="row mt-5" style="overflow: scroll;">
    <div class="col-md-4 stretch-card transparent">
           <div class="card card-tale" style="cursor: context-menu;">
            <div class="card-body">
              <div>
              <p class="">
                <img src="{% static 'img/images/vodacom.jpg' %}" class="img-fluid" alt="">
              </p>
              <p class="pt-3" style="font-size: 16px; font-weight: 600;">
                Vodacom Tanzania Deposit
              </p>
               <ol start="" style="font-weight: 600;">
                <li>Dial *150*00#"</li>
                <li>Select Send Money</li>
                <li>Select International Transfer</li>
                <li>Select Safaricom Mpesa</li>
                <li>Enter Pin</li>
              </ol>
              <p class="" style="font-size: 12px; font-weight: 600;">
               REFRESH THE DASHBOARD AND WITHIN 5 MINUTES THE AMOUNT WILL REFLECT.
             </p>
             </div>
              <div>
              </div>
            </div>
          </div>
        </div>
      <div class="col-md-4 stretch-card transparent">
           <div class="card card-tale" style="cursor: context-menu;">
            <div class="card-body">
              <div>
              <p class="">
                <img src="{% static 'img/mtn-rwanda.jpg' %}" class="img-fluid" alt="">
              </p>
              <p class="pt-3" style="font-size: 16px; font-weight: 600;">
                MTN RWANDA Deposit
              </p>
               <ol start="" style="font-weight: 600;">
                <li>Dial *830#</li>
                <li>Select Send Money</li>
                <li>Select International Transfer</li>
                <li>Select Safaricom Mpesa</li>
            
                <li>Enter Pin</li>
              </ol>
                <p class="" style="font-size: 12px; font-weight: 600;">
                REFRESH THE DASHBOARD AND WITHIN 5 MINUTES THE AMOUNT WILL REFLECT.
              </p>
         
              </div>
              <div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 stretch-card transparent">
           <div class="card card-tale" style="cursor: context-menu;">
            <div class="card-body">
              <div>
              <p class="">
                <img src="{% static 'img/mtn.jpg' %}" class="img-fluid" alt="">
              </p>
              <p class="pt-3" style="font-size: 16px; font-weight: 600;">
                MTN UGANDA Deposit
              </p>
              <ol start="" style="font-weight: 600;">
                <li>Dial *165#</li>
                <li>Select Send Money</li>
                <li>Select International Transfer</li>
                <li>Select Safaricom Mpesa</li>
              
                <li>Enter Pin</li>
              </ol>
                <p class="" style="font-size: 12px; font-weight: 600;">
                REFRESH THE DASHBOARD AND WITHIN 5 MINUTES THE AMOUNT WILL REFLECT.
              </p>
         
              </div>
              <div>
              </div>
            </div>
          </div>
        </div>
       
    </div>

  <div class="card mt-5">
    <h4>Deposits Table</h4>

    <table class="mt-3">
    <thead>
    <tr>
      <th>SN</th>
      <th>Amount</th>
      <th>Reference Code</th>
      <th>Date</th>
      <th>Payment Confirmed</th>
    </tr>
    </thead>

    <tbody>
      {% for user_deposit in user_deposits %}
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>{{ user_deposit.amount }}</td>
      <td>{{ user_deposit.reference_code }}</td>
      <td>{{ user_deposit.created }}</td>
   
      <td>
        {% if user_deposit.paid %}
            <button class="btn text-white" style="background: #28a745;">Approved</button>
        {% else %}
            <button class="btn text-white" style="background: #F3797E;">Pending</button>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
    </tbody>

    </table>

    <div class="pagination mt-3">
    <button>Previous</button>
    <button>1</button>
    <button>Next</button>
    </div>
</div>


<!-- Styles -->
<style>
  #messageBox {
    height: 44px;
    /* padding: 12px 16px;
    margin-top: 10px; */
    margin: 10px 0px;
    padding-left: 10px;
    border-radius: 6px;
    font-weight: 500;
    font-size: 14px;
    display: none; /* Hidden until shown by JS */
    transition: all 0.3s ease-in-out;
   align-content: center;
  }

  .message-processing {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
  }

  .message-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .message-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }
</style>

<!-- Script -->
<script>
  function setMessage(text, type) {
      const messageBox = document.getElementById("messageBox");
      messageBox.style.display = "block";
      messageBox.className = ""; // Reset all styles
      messageBox.innerText = text;

      if (type === "processing") {
          messageBox.classList.add("message-processing");
      } else if (type === "success") {
          messageBox.classList.add("message-success");
      } else if (type === "error") {
          messageBox.classList.add("message-error");
      }
  }

  document.getElementById("depositForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const form = e.target;
      const formData = new FormData(form);
      setMessage(`Processing your deposit... on ${depositForm.phone}`, "processing");

      try {
          const response = await fetch("{% url 'deposits:ajax_deposit' %}", {
              method: "POST",
              headers: {
                  "X-CSRFToken": formData.get("csrfmiddlewaretoken")
              },
              body: formData
          });

          const data = await response.json();
          console.log("API Response:", data);

          if (data.ok) {
              setMessage(data.message || "STK Push sent to your phone. Please authorize.", "success");
              if (data.checkout_request_id) {
                  pollPaymentStatus(data.checkout_request_id);
              }
          } else {
              setMessage(data.error || "Something went wrong.", "error");
          }

      } catch (err) {
          console.error("AJAX error:", err);
          setMessage("Network or server error. Try again.", "error");
      }
  });

  function pollPaymentStatus(checkoutRequestId) {
      const interval = setInterval(async () => {
          try {
              const res = await fetch(`/deposits/status/${checkoutRequestId}/`);
              const result = await res.json();

              if (result.status === "paid") {
                  clearInterval(interval);
                  setMessage("Payment successful. Thank you!", "success");
              } else if (result.status === "failed") {
                  clearInterval(interval);
                  setMessage("Payment failed. Please try again.", "error");
              }
              // Otherwise, continue polling
          } catch (err) {
              clearInterval(interval);
              console.error("Polling error:", err);
              setMessage("Error checking payment status.", "error");
          }
      }, 5000); // Poll every 5 seconds
  }
</script>


<!-- <script>
  document.getElementById("depositForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const form = e.target;
      const formData = new FormData(form);
      const messageBox = document.getElementById("messageBox");
      messageBox.innerText = "Processing your deposit...";

      try {
          const response = await fetch("{% url 'deposits:ajax_deposit' %}", {
              method: "POST",
              headers: {
                  "X-CSRFToken": formData.get("csrfmiddlewaretoken")
              },
              body: formData
          });

          const data = await response.json();
          console.log("API Response:", data);

          if (data.ok) {
              messageBox.innerText = data.message || "STK Push sent to your phone. Please authorize.";
              if (data.checkout_request_id) {
                  pollPaymentStatus(data.checkout_request_id);
              }
          } else {
              messageBox.innerText = data.error || "Something went wrong.";
          }

      } catch (err) {
          console.error("AJAX error:", err);
          messageBox.innerText = "Network or server error. Try again.";
      }
  });

  function pollPaymentStatus(checkoutRequestId) {
      const messageBox = document.getElementById("messageBox");

      const interval = setInterval(async () => {
          try {
              const res = await fetch(`/deposits/status/${checkoutRequestId}/`);
              const result = await res.json();

              if (result.status === "paid") {
                  clearInterval(interval);
                  messageBox.innerText = "Payment successful. Thank you!";
              } else if (result.status === "failed") {
                  clearInterval(interval);
                  messageBox.innerText = "Payment failed. Please try again.";
              }
              // Keep polling otherwise
          } catch (err) {
              clearInterval(interval);
              console.error("Polling error:", err);
              messageBox.innerText = "Error checking payment status.";
          }
      }, 5000); // Check every 5 seconds
  }
</script> -->




<!-- <script>
  document.getElementById("depositForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const messageBox = document.getElementById("messageBox");
  
      try {
          const response = await fetch("{% url 'deposits:ajax_deposit' %}", {
              method: "POST",
              headers: {
                  "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
              },
              body: formData
          });
  
          const data = await response.json()  
          console.log(data);
          if (data.success) {
              messageBox.innerText = "STK Push sent to your phone. Please authorize.";
              pollPaymentStatus(data.checkout_request_id);
          } else {
              messageBox.innerText = data.error || "Something went wrong.";
          }
  
      } catch (err) {
          console.error(err);
          messageBox.innerText = "Network or server error.";
      }
  });
  
  function pollPaymentStatus(checkoutRequestId) {
      const messageBox = document.getElementById("messageBox");
  
      const interval = setInterval(async () => {
          try {
              const res = await fetch(`/deposits/status/${checkoutRequestId}/`);
              const result = await res.json();
  
              if (result.status === "paid") {
                  clearInterval(interval);
                  messageBox.innerText = "Payment successful. Thank you!";
              } else if (result.status === "failed") {
                  clearInterval(interval);
                  messageBox.innerText = "Payment failed. Try again.";
              }
              // Otherwise, keep polling...
          } catch (err) {
              clearInterval(interval);
              messageBox.innerText = "Error checking status.";
          }
      }, 5000); // Poll every 5 seconds
  }
</script> -->
  

{% endblock %}